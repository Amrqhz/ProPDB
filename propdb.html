<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ProPDB — amrqhz</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/3Dmol/1.6.3/3Dmol-min.js"></script>

  <style>
    :root{
      --radius:12px;
      --muted:#9aa6b2;
      --accent-grad: linear-gradient(90deg,#6ee7b7,#39a6ff);
      --bg: linear-gradient(180deg,#071421,#091428);
      --card: rgba(11,18,32,0.78);
      --text:#e6eef6;
      --control-bg: rgba(255,255,255,0.02);
      --btn-bg: linear-gradient(90deg,#6ee7b7,#39a6ff);
    }

    html,body{height:100%; margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; color:var(--text); background:var(--bg);}

    .app { display:grid; grid-template-columns:320px 1fr; gap:16px; height:100vh; padding:16px; box-sizing:border-box; }
    @media (max-width:900px){ .app{ grid-template-columns:1fr; grid-auto-rows:auto 1fr; padding:8px; } }

    /* Sidebar */
    .sidebar { background:var(--card); border-radius:var(--radius); padding:16px; display:flex; flex-direction:column; gap:12px; box-shadow:0 10px 30px rgba(133, 133, 133, 0.6); border:1px solid rgba(255,255,255,0.02); overflow:auto; }
    .brand { display:flex; gap:10px; align-items:center; background-color: #d1d1d1; border-radius: 12px; justify-content: center;}
    /* .logo { width:44px;height:44px;border-radius:10px; display:flex; align-items:center; justify-content:center; font-weight:800; color:#02121a; background:linear-gradient(135deg,#43e97b,#28a7ff); } */  
    .logo img { width:45px; height:39px; margin-top: 10px; }


    .title { font-size:1.05rem; font-weight:700; }
    .subtitle { color:var(--muted); font-size:0.86rem; }

    .control { background:var(--control-bg); padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); }
    .control small{ display:block; color:var(--muted); margin-bottom:6px; font-size:0.86rem; }
    .row { display:flex; gap:8px; align-items:center; }

    input[type="text"], select, .small-input { width:100%; padding:9px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:inherit; outline:none; font-size:0.95rem; box-sizing:border-box; }
    input[type="file"] { color:var(--muted); }

    .btn { padding:9px 12px; border-radius:10px; border:0; cursor:pointer; font-weight:700; background:var(--btn-bg); color:#02121a; box-shadow:0 8px 18px rgba(44,187,150,0.08); }
    .btn.ghost { background:transparent; color:var(--text); border:1px solid rgba(255,255,255,0.06); font-weight:600; }
    .btn.small { padding:7px 8px; font-size:0.92rem; border-radius:8px; }

    /* Viewer */
    .viewer-wrap { border-radius:var(--radius); overflow:hidden; position:relative; display:flex; flex-direction:column; box-shadow:0 10px 30px rgba(133, 133, 133, 0.6); border:1px solid rgba(255,255,255,0.02); }
    #viewer { flex:1; min-height:420px; background:transparent; }
    .floating-panel { position:absolute; right:10px; bottom:10px; background: #d1d1d171; padding:12px; border-radius:12px; min-width:220px; color:var(--muted); }
    .muted { color:var(--muted); }

    .loading-overlay { position:absolute; inset:0; display:none; align-items:center; justify-content:center; z-index:80; background:linear-gradient(180deg, rgba(2,6,23,0.65), rgba(2,6,23,0.45)); font-weight:700; color:var(--muted); }
    .loading-card { text-align:center; padding:16px; border-radius:10px; background: rgba(0,0,0,0.35); border:1px solid rgba(255,255,255,0.03); }

    .help-overlay { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:90; background: rgba(2,6,23,0.6); }
    .help-card { background:var(--card); padding:18px; border-radius:10px; width:500px; max-width:95%; color:var(--text); }

    footer.small { font-size:0.78rem; color:var(--muted); text-align:center; padding:8px; }

    /* smooth */
    .control, .btn, select, input[type="text"]{ transition: all 150ms ease; }
    .btn:hover{ transform:translateY(-1px); }
  </style>
</head>
<body>
  <div class="app" id="app">
    <aside class="sidebar" aria-label="Controls">
      <div class="brand">
        <div class="logo">
          <img src="Group 84.svg" alt="Pro pdb logo">
        </div>
        <!-- <div class="logo">P.P</div> -->
        <div>
          <div class="title" style="color: #071421;">ProPDB</div>
          <!-- <div class="subtitle">3Dmol.js — your new Visualizer</div> -->
        </div>
      </div>

      <div class="control" id="load-control">
        <small>Load (local or RCSB)</small>
        <input id="file-input" type="file" accept=".pdb,.ent,.cif,.mmcif,.sdf,.mol2" style="margin: 10px 0 10px 0;"/>
        <div style="height:10px;"></div>
        <div class="row">
          <input id="pdbid" type="text" placeholder="PDB ID (e.g. 6hdf)" />
          <button id="fetch-btn" class="btn small">Fetch</button>
        </div>
        <div style="height:8px;"></div>
        <div id="load-status" class="muted" style="margin: 10px 0 10px 0;">Ready</div>
      </div>

      <div class="control" id="representation-control">
        <small>Main representation</small>
        <select id="rep-select" class="small-input" style="background-color: #091428;">
          <option value="cartoon">Cartoon / Ribbon</option>
          <option value="line">Line</option>
          <option value="stick">Stick</option>
          <option value="sphere">Sphere (CPK)</option>
          <option value="surface">Surface</option>
          <option value="cartoon+stick">Cartoon + Ligands</option>
        </select>

        <div style="height:8px;"></div>
        <small>Coloring</small>
        <select id="color-select" class="small-input" style="background-color: #091428;">
          <option value="spectrum">Spectrum</option>
          <option value="chain">By chain</option>
          <option value="residue">By residue</option>
          <option value="element">By element (CPK)</option>
          <option value="secondary">By secondary structure</option>
          <option value="uniform">Uniform (gray)</option>
        </select>
      </div>

      <div class="control" id="ligand-control">
        <small>Ligand selection</small>
        <select id="ligand-dropdown" class="small-input" style="background-color: #091428;">
          <option value="none">None</option>
          <option value="all">All ligands</option>
        </select>

        <div style="height:8px;"></div>
        <small>Ligand style</small>
        <select id="lig-style" class="small-input" style="background-color: #091428;">
          <option value="stick">Stick</option>
          <!-- <option value="sphere">Sphere</option>
          <option value="surface">Surface</option> -->
        </select>

        <div style="height:8px;"></div>
        <small>Ligand color</small>
        <select id="lig-color" class="small-input" style="background-color: #091428;" >
          <option value="element">CPK (element)</option>
          <option value="uniform">Uniform (yellow)</option>
          <option value="chain">By chain</option>
        </select>
      </div>

      <div class="control" id="render-control">
        <small>Rendering & tools</small>
        <div class="row" style="margin-top:8px;">
          <button id="center-btn" class="btn ghost small">Center</button>
          <button id="reset-btn" class="btn ghost small">Reset</button>
        </div>

        <div style="height:8px;"></div>
        <div class="row">
          <button id="snapshot-btn" class="btn small">Snapshot</button>
          <button id="spin-btn" class="btn ghost small">Spin</button>
        </div>

        <div style="height:8px;"></div>
        <div class="muted">Tip: C = center, R = reset, S = snapshot</div>
      </div>

      <div style="flex:1"></div>
      <footer class="small">Client-side • 3Dmol.js • Ligand dropdown control</footer>
    </aside>

    <main class="viewer-wrap" aria-label="Viewer">
      <div id="viewer"></div>

      <div class="loading-overlay" id="loading">
        <div class="loading-card">
          Loading...
          <div id="loading-info" class="muted" style="margin-top:8px; font-weight:400;"></div>
        </div>
      </div>

      <div class="floating-panel" id="floating-panel">
        <div style="font-weight:300; margin-bottom:6px;">Selection</div>
        <div id="selection-list" class="muted">No atoms selected.</div>
        <div id="measure-info" class="muted" style="margin-top:8px;">Click two atoms to measure distance (Å).</div>
      </div>
    </main>
  </div>

  <!-- Help modal -->
  <div class="help-overlay" id="help-overlay">
    <div class="help-card">
      <h3 style="margin-top:0">ProfessorX Visualizer — Help</h3>
      <p class="muted">Shortcuts & tips</p>
      <ul>
        <li><strong>C</strong> — Center view</li>
        <li><strong>R</strong> — Reset camera</li>
        <li><strong>S</strong> — Save snapshot</li>
        <li>Use the ligand dropdown to show a specific ligand, All ligands, or None.</li>
        <li>Change ligand style and color in the ligand panel.</li>
      </ul>
      <div style="text-align:right; margin-top:10px;">
        <button id="help-close" class="btn small ghost">Close</button>
      </div>
    </div>
  </div>

  <script>
    // Helper
    const el = id => document.getElementById(id);

    // Viewer & state
    const viewerDiv = el('viewer');
    viewerDiv.style.height = 'calc(100vh - 48px)';
    const viewer = $3Dmol.createViewer(viewerDiv, { defaultcolors: $3Dmol.rasmolElementColors, backgroundColor: 0x071421, antialias:true });
    let currentModel = null;
    let selectedAtoms = [];
    let spinInterval = null;
    let spinUsingAPI = false;
    let ligandGroups = []; // {id: 'ATP A:501', resn:'ATP', chain:'A', resi:'501'}

    // Loading helper
    function showLoading(text){
      el('loading-info').textContent = text || '';
      el('loading').style.display = 'flex';
    }
    function hideLoading(){ el('loading').style.display = 'none'; }

    // Format guess
    function guessFormat(name){
      if(!name) return 'pdb';
      const s = name.toLowerCase();
      if(s.endsWith('.cif')||s.endsWith('.mmcif')) return 'mmcif';
      if(s.endsWith('.sdf')) return 'sdf';
      return 'pdb';
    }

    // Utility: group ligands (hetflag true) by resn+resi+chain
    function detectLigands(model){
      ligandGroups = [];
      if(!model) return ligandGroups;
      const hetAtoms = model.selectedAtoms({hetflag:true});
      if(!hetAtoms || hetAtoms.length === 0) return ligandGroups;

      const ignoreResn = [
        'HOH','WAT','H2O','NA','CL','MG','CA','K','ZN','MN','CU','CO','FE','SO4','PO4',
        'ACT','DMS','MPD','PEG','NAG','GOL','EDO','IPA','TRS'
      ];

      const map = {};
      for(const a of hetAtoms){
        const resn = a.resn.trim().toUpperCase();
        if(ignoreResn.includes(resn)) continue;
        const key = `${resn} ${a.chain}:${a.resi}`;
        if(!map[key]) map[key] = {resn:a.resn, chain:a.chain, resi:a.resi, atoms:[]};
        map[key].atoms.push(a);
      }

      // filter out tiny molecules (like single atoms)
      for(const k of Object.keys(map)){
        if(map[k].atoms.length < 6) delete map[k];
      }

      ligandGroups = Object.values(map).sort((a,b)=>a.id?.localeCompare?.(b.id) || 0);
      ligandGroups.forEach(g => g.id = `${g.resn} ${g.chain}:${g.resi}`);
      return ligandGroups;
    }

    // Populate ligand dropdown
    function populateLigandDropdown(){
      const dd = el('ligand-dropdown');
      const prev = dd.value;
      dd.innerHTML = '';
      const optNone = document.createElement('option'); optNone.value='none'; optNone.textContent='None';
      const optAll = document.createElement('option'); optAll.value='all'; optAll.textContent='All ligands';
      dd.appendChild(optNone);
      dd.appendChild(optAll);
      for(const g of ligandGroups){
        const o = document.createElement('option');
        o.value = JSON.stringify({resn:g.resn, chain:g.chain, resi:g.resi});
        o.textContent = g.id;
        dd.appendChild(o);
      }
      // try to restore previous if still valid
      if([...''].includes(prev)){ dd.value = prev; } // noop but keep structure
    }

    // Clear selection markers and labels
    function clearSelection(){
      selectedAtoms.forEach(a=>{ if(a._selLabel) viewer.removeLabel(a._selLabel); });
      selectedAtoms = [];
      viewer.removeAllShapes('selection_spheres');
      viewer.removeAllShapes('measure_cylinders');
      el('selection-list').innerHTML = 'No atoms selected.';
      el('measure-info').textContent = 'Click two atoms to measure distance (Å).';
      viewer.render();
    }

    // Apply main representation & re-style ligands according to dropdown
    function applyRepresentation(){
      if(!currentModel) return;
      const rep = el('rep-select').value;
      const colorSel = el('color-select').value;
      // clear first
      viewer.setStyle({}, {});
      // main (exclude hetflag)
      const mainColor = mapColor(colorSel);
      if(rep === 'cartoon' || rep === 'cartoon+stick'){
        viewer.setStyle({hetflag:false}, {cartoon:{color: mainColor}});
      } else if(rep === 'line'){
        viewer.setStyle({hetflag:false}, {line:{}});
      } else if(rep === 'stick'){
        viewer.setStyle({hetflag:false}, {stick:{radius:0.14, colorscheme: mainColor}});
      } else if(rep === 'sphere'){
        viewer.setStyle({hetflag:false}, {sphere:{scale:0.35, color: mainColor}});
      } else if(rep === 'surface'){
        // surface can be heavy; limit detail by not giving very fine resolution
        viewer.setStyle({hetflag:false}, {surface:{opacity:0.90, color: mainColor}});
      }

      // If rep indicates cartoon+stick, ensure ligands also visible as sticks (or by chosen)
      // Ligand style applied separately by applyLigandStyle()
      applyLigandStyle(); // uses dropdown + ligandGroups

      viewer.zoomTo();
      viewer.render();
    }

    function mapColor(sel){
      if(sel==='chain') return 'chain';
      if(sel==='residue') return 'residue';
      if(sel==='spectrum') return 'spectrum';
      if(sel==='element') return 'element';
      if(sel==='secondary') return 'spectrum'; // 3Dmol supports ss but mapping is not standard here
      if(sel==='uniform') return 'grey';
      return 'spectrum';
    }

    // Apply ligand style based on dropdown selection
    function applyLigandStyle(){
      if(!currentModel) return;
      const ligSel = el('ligand-dropdown').value; // 'none' | 'all' | JSON
      const style = el('lig-style').value; // stick/sphere/surface
      const colorOpt = el('lig-color').value; // element/uniform/chain

      // clear existing ligand style (we will reapply)
      viewer.setStyle({hetflag:true}, {}); // remove

      // choose color strategy for ligand
      let colorStrategy = 'element';
      if(colorOpt === 'element') colorStrategy = 'element';
      else if(colorOpt === 'uniform') colorStrategy = 'grey';
      else if(colorOpt === 'chain') colorStrategy = 'chain';

      if(ligSel === 'none'){
        // don't render ligands
        viewer.render();
        return;
      }

      if(ligSel === 'all'){
        // apply to all hetflag atoms
        if(style === 'stick'){
          viewer.setStyle({hetflag:true}, {stick:{radius:0.18, colorscheme: colorStrategy}});
        } else if(style === 'sphere'){
          viewer.setStyle({hetflag:true}, {sphere:{scale:0.38, color: colorStrategy}});
        } else if(style === 'surface'){
          viewer.setStyle({hetflag:true}, {surface:{opacity:0.95, color: colorStrategy}});
        }
      } else {
        // parse JSON selection
        let selObj = null;
        try { selObj = JSON.parse(ligSel); } catch(e){ selObj = null; }
        if(selObj){
          // selection filter: match resn, chain, resi
          const selFilter = {resn: selObj.resn, chain: selObj.chain, resi: selObj.resi};
          if(style === 'stick'){
            viewer.setStyle(selFilter, {stick:{radius:0.18, colorscheme: colorStrategy}});
          } else if(style === 'sphere'){
            viewer.setStyle(selFilter, {sphere:{scale:0.38, color: colorStrategy}});
          } else if(style === 'surface'){
            viewer.setStyle(selFilter, {surface:{opacity:0.95, color: colorStrategy}});
          }
        }
      }
      viewer.render();
    }

    // Load model from string (pdb or mmcif)
    function loadModelFromString(txt, fmt, sourceLabel){
      showLoading('Parsing & rendering...');
      el('load-status').textContent = 'Loading ' + (sourceLabel||'file') + ' ...';
      // clear viewer
      viewer.clear();
      currentModel = null;
      ligandGroups = [];
      populateLigandDropdown(); // reset

      try {
        currentModel = viewer.addModel(txt, fmt || 'pdb');
        // initial quick style while heavy things settle
        viewer.setStyle({}, {cartoon:{color:'spectrum'}});
        viewer.zoomTo();
        viewer.render();

        // detect ligands and populate dropdown
        ligandGroups = detectLigands(currentModel);
        populateLigandDropdown();

        // default: show all ligands if present, else none
        if(ligandGroups.length > 0){
          el('ligand-dropdown').value = 'all';
        } else {
          el('ligand-dropdown').value = 'none';
        }

        // apply user-selected representation and ligand style
        applyRepresentation();
        setTimeout(setupInteractions, 300);

        // setup interactions
        setupInteractions();

        hideLoading();
        el('load-status').textContent = 'Loaded — atoms: ' + currentModel.selectedAtoms({}).length;
      } catch(e){
        hideLoading();
        el('load-status').textContent = 'Load failed';
        alert('Failed to parse model: ' + e.message);
      }
    }

    // File input handling
    el('file-input').addEventListener('change', function(e){
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = function(ev){
        const txt = ev.target.result;
        const fmt = guessFormat(f.name);
        loadModelFromString(txt, fmt, f.name);
      };
      reader.readAsText(f);
    });

    // Fetch by PDB id (tries .pdb then .cif)
    el('fetch-btn').addEventListener('click', async ()=>{
      const id = (el('pdbid').value || '').trim();
      if(!id){ alert('Enter a PDB ID'); return; }
      const pid = id.toLowerCase();
      showLoading('Fetching from RCSB...');
      el('load-status').textContent = 'Fetching ' + pid;
      try {
        const resp = await fetch(`https://files.rcsb.org/download/${pid}.pdb`);
        if(resp.ok){
          const txt = await resp.text();
          loadModelFromString(txt, 'pdb', pid + '.pdb');
          return;
        }
        // fallback cif
        const resp2 = await fetch(`https://files.rcsb.org/download/${pid}.cif`);
        if(resp2.ok){
          const txt2 = await resp2.text();
          loadModelFromString(txt2, 'mmcif', pid + '.cif');
          return;
        }
        throw new Error('Not found at RCSB');
      } catch(err){
        hideLoading();
        el('load-status').textContent = 'Fetch failed';
        alert('Fetch failed: ' + err.message);
      }
    });

    // Dropdown & control events
    el('rep-select').addEventListener('change', ()=> applyRepresentation());
    el('color-select').addEventListener('change', ()=> applyRepresentation());
    el('lig-style').addEventListener('change', ()=> applyLigandStyle());
    el('lig-color').addEventListener('change', ()=> applyLigandStyle());
    el('ligand-dropdown').addEventListener('change', ()=> applyLigandStyle());

    // Snapshot
    el('snapshot-btn').addEventListener('click', ()=>{
      try {
        const data = viewer.renderToImage(); // returns dataURL
        const a = document.createElement('a'); a.href = data; a.download = 'snapshot.png'; document.body.appendChild(a); a.click(); a.remove();
      } catch(e){
        try { // fallback
          const data = viewer.pngURI();
          const a = document.createElement('a'); a.href = data; a.download = 'snapshot.png'; document.body.appendChild(a); a.click(); a.remove();
        } catch(e){
          alert('Snapshot failed: ' + e.message);
        }
      }
    });

    // Spin (native if supported, else interval fallback)
    let fallbackSpinInterval = null;
    function startSpin(){
      try {
        // try native API (some versions)
        viewer.spin(true);
        spinUsingAPI = true;
      } catch(e){
        spinUsingAPI = false;
        if(fallbackSpinInterval) clearInterval(fallbackSpinInterval);
        fallbackSpinInterval = setInterval(()=> { try{ viewer.spin(1); } catch(e){} }, 40);
      }
      el('spin-btn').textContent = 'Stop';
    }
    function stopSpin(){
      try { viewer.spin(false); } catch(e){}
      if(fallbackSpinInterval){ clearInterval(fallbackSpinInterval); fallbackSpinInterval = null; }
      el('spin-btn').textContent = 'Spin';
    }
    let spinning = false;
    el('spin-btn').addEventListener('click', ()=>{
      if(!spinning){ startSpin(); spinning = true; } else { stopSpin(); spinning = false; }
    });

    // Center & reset
    el('center-btn').addEventListener('click', ()=> { try{ viewer.zoomTo(); viewer.render(); } catch(e){} });
    el('reset-btn').addEventListener('click', ()=> { try{ viewer.setView({rotation:[0,0,0], translation:[0,0,0], zoom:1}); viewer.zoomTo(); viewer.render(); } catch(e){} });

    // Selection & measurement: hover & click
    function setupInteractions(){
      if(!currentModel) return;
      viewer.setClickable({}, true, function(atom, viewerRef, event, container){
        if(!atom) return;
        if(selectedAtoms.length >= 2){
          clearSelection();
        }
        selectedAtoms.push(atom);
        const lab = viewerRef.addLabel(
          `${atom.atom}:${atom.resn}${atom.resi}`,
          {position:atom, fontSize:12, backgroundColor:'rgba(8,16,24,0.9)'}
        );
        atom._selLabel = lab;
        viewerRef.addSphere({center:atom, radius:0.4, color:'0xFFFF00', opacity:0.9}, 'selection_spheres');

        el('selection-list').innerHTML = selectedAtoms.map((a,i)=>
          `${i+1}. ${a.atom} ${a.resn}${a.resi} (${a.elem})`
        ).join('<br/>');

        if(selectedAtoms.length === 2){
          const [a0,a1] = selectedAtoms;
          const dx=a0.x-a1.x, dy=a0.y-a1.y, dz=a0.z-a1.z;
          const dist=Math.sqrt(dx*dx+dy*dy+dz*dz);
          el('measure-info').textContent = `Distance: ${dist.toFixed(2)} Å`;
          viewerRef.addCylinder({
            start:a0, end:a1, radius:0.08, fromCap:true, toCap:true,
            color:'0xFFFF00', opacity:0.9
          }, 'measure_cylinders');
        }
        viewerRef.render();
      });

      // hover labels (optional)
      viewer.setHoverable({}, true, function(atom, viewerRef){
        if(atom && !atom._hoverLabel){
          atom._hoverLabel = viewerRef.addLabel(
            `${atom.atom} ${atom.resn}${atom.resi}`, 
            {position:atom, fontSize:12, backgroundColor:'rgba(0,0,0,0.6)'}
          );
          viewerRef.render();
        }
      }, function(atom, viewerRef){
        if(atom && atom._hoverLabel){
          viewerRef.removeLabel(atom._hoverLabel);
          delete atom._hoverLabel;
          viewerRef.render();
        }
      });
    }


    // Detect ligands & populate dropdown after model loaded - already done inside loadModelFromString
    // But add listener so user can open dropdown after load
    // No-op

    // Clear selection via double-click on viewer (convenience)
    viewerDiv.addEventListener('dblclick', ()=> clearSelection());

    // Keyboard shortcuts
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'c' || e.key === 'C') el('center-btn').click();
      if(e.key === 'r' || e.key === 'R') el('reset-btn').click();
      if(e.key === 's' || e.key === 'S') el('snapshot-btn').click();
    });

    // Initial friendly state
    el('load-status').textContent = 'Ready — load a file or fetch by PDB ID.';

    // Expose a minimal API on window for debugging if needed (optional)
    window._pxv = { viewer, loadModelFromString: loadModelFromString };

    // END
  </script>
</body>
</html>

